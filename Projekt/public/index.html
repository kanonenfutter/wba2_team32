<html>
    <head>
        <title>Projekt: Mitfahrgelegenheit</title>
        <!--Einbindung von jQuery (Nur mit Internetverbindung?)-->
        <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <!-- Faye laden -->
        <script src='/faye/client.js'></script>
        <!-- <link rel="stylesheet" type="text/css" href="styles.css">-->
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <!-- Optional theme -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
    </head>
    <body>
        <div class="navbar navbar-inverse">
            <div class="container">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/">Home</a></li>
                    <li><a href="/add.html">Fahrt hinzufügen</a></li>
                    <li><a href="/meine_fahrten.html">Meine Fahrten</a></li> 
                    <li>Fahrtensuche
                        <form class="form" name='search' id='search' action='/fahrten' method='GET'>
                            <input class="input-xlarge" name='search' id='search' type='text' value="Zielort"></input>
                            <input class="btn btn-default" type='submit' name='submit' value='Suchen'></input>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
        <div class="container">
            <h2>Alle angebotene Fahrten</h2>
            <!-- Tabellenkopf, neue fahrten werden hier hinzugefuegt -->
            <table class="table table-bordered table-striped" id='tabelle' border='1'>
                <tr>
                    <th>Username</th>
                    <th>Abfahrtsort</th>
                    <th>Ankunftsort</th>
                    <th>Datum</th>
                    <th>Abfahrtszeit</th>
                    <th>Freie Plätze</th>
                    <th>Details</th>
                </tr>
            </table>
            <div id='output'>
                test
            </div>
        </div>

        <script type="text/javascript">
            // PubSub client erstellen
            var client = new Faye.Client('/faye');
            // Topic '/fahrten' subscriben
            var subscription = client.subscribe('/fahrten', function(message) {
                addTableRow(message);
            });
    
            // get auf Ressource '/fahrten'
            var ajaxGet = $.ajax({
                url: '/fahrten',
                type: 'GET',
                contentType: 'application/json'
            });
            // Tabellenerweiterung mit Aufruf von addTableRow wenn Promise erfolgreich
            ajaxGet.done(function(data) {
                data.forEach(function(fahrt) {
                addTableRow(fahrt);
                });
            });
            // Popup mit Fehlermeldung wenn Promise fehlgeschlagen
            ajaxGet.fail(function(e) {
                alert('Fehler:' + JSON.stringify(e) + ')');
            });
            // Zeile/Dokument zur Tabelle hinzufuegen 
            var addTableRow = function(fahrt) {
                $('#tabelle').append('<tr><td>' + fahrt.name + '</td><td>' + fahrt.start + '</td><td>' + fahrt.destination + '</td><td>' + fahrt.date + '</td><td>' + fahrt.time + '</td><td>' + fahrt.seats + '</td><td>'+ '<a href="/fahrten/'+ fahrt._id + '">mehr</a></td></tr>');
            };
        </script>
    </body>
</html>
